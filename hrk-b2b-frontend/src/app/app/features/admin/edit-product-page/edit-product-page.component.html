<div class="edit-product-container add-product-container">
  <!-- Header negro con logo y navegaci√≥n -->
  <div class="admin-header">
    <div class="header-left">
      <div class="logo" (click)="goToCatalog()">
        <div class="logo-symbol">
          <img src="/HIRKUM-MONOGRAMA-B.jpg" alt="HIRKUM Logo" class="logo-image">
        </div>
        <span>HRK</span>
      </div>
      <nav class="main-nav">
        <a (click)="goToCatalog()" class="nav-item">SHOP</a>
        <a (click)="goToCatalog()" class="nav-item sale">SALE</a>
        <a (click)="goToInfo()" class="nav-item info">info</a>
      </nav>
    </div>
    
    <div class="header-right">
      <button class="icon-btn cart-icon" title="Carrito" (click)="goToCart()">
        üõí
        <span *ngIf="cartItemCount > 0" class="cart-badge">{{ cartItemCount }}</span>
      </button>
      <button class="icon-btn search-icon" title="Buscar" (click)="openSearchModal()">
        üîç
      </button>
      <button class="icon-btn history-btn" title="Historial de Pedidos" (click)="goToHistory()">
        üìã
      </button>
      <button class="icon-btn user-icon" title="Perfil de Usuario" (click)="goToProfile()">
        <img src="/images/user-icon.png" alt="Usuario" class="user-icon-img"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
        <span class="user-icon-fallback" style="display:none;">üë§</span>
      </button>
      <button class="logout-btn" (click)="logout()" title="Cerrar Sesi√≥n">
        Cerrar Sesi√≥n
      </button>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="form-container">
    <div class="form-header">
      <h1 *ngIf="loadingProduct">Cargando producto...</h1>
      <h1 *ngIf="!loadingProduct">‚úèÔ∏è Modificar Producto</h1>
    </div>

    <div *ngIf="loadingProduct" class="loading">Cargando producto...</div>

    <div *ngIf="!loadingProduct" class="edit-product-content">
      <!-- Secci√≥n 1: Imagen y Nombre -->
      <div class="product-header-section">
        <div class="product-image-container">
          <img 
            [src]="productData.imagenBase64 || imagenActualUrl" 
            [alt]="productData.nombre || 'Imagen del producto'"
            class="product-main-image"
          >
          <button 
            class="edit-icon-btn image-edit-btn" 
            (click)="toggleImageEdit()"
            title="Cambiar imagen"
          >
            ‚úèÔ∏è
          </button>
          <input 
            type="file" 
            id="imagen-input" 
            style="display: none;"
            (change)="onImageSelected($event)"
            accept="image/*"
            #imageInput
          >
        </div>
        
        <div class="product-info-header">
          <div class="product-name-container">
            <h2 
              *ngIf="!editingName" 
              class="product-name-display"
              (click)="toggleNameEdit()"
            >
              {{ productData.nombre }}
              <span class="edit-hint">‚úèÔ∏è</span>
            </h2>
            <div *ngIf="editingName" class="product-name-edit">
              <input 
                type="text" 
                [(ngModel)]="productData.nombre"
                class="form-control name-input"
                (blur)="toggleNameEdit()"
                (keyup.enter)="toggleNameEdit()"
                #nameInput
              >
            </div>
          </div>
          
          <div class="product-description-container">
            <p 
              *ngIf="!editingDescription" 
              class="product-description-display"
              (click)="toggleDescriptionEdit()"
            >
              {{ productData.descripcion || 'Sin descripci√≥n' }}
              <span class="edit-hint">‚úèÔ∏è</span>
            </p>
            <div *ngIf="editingDescription" class="product-description-edit">
              <textarea 
                [(ngModel)]="productData.descripcion"
                class="form-control description-input"
                rows="3"
                (blur)="toggleDescriptionEdit()"
                #descriptionInput
              ></textarea>
            </div>
          </div>
          
          <div class="product-price-container">
            <div 
              *ngIf="!editingPrice" 
              class="product-price-display"
              (click)="togglePriceEdit()"
            >
              <strong>Precio:</strong> ${{ productData.precio | number:'1.2-2' }}
              <span class="edit-hint">‚úèÔ∏è</span>
            </div>
            <div *ngIf="editingPrice" class="product-price-edit">
              <label for="precio-input">Precio:</label>
              <input 
                type="number" 
                id="precio-input"
                [(ngModel)]="productData.precio"
                class="form-control price-input"
                min="0" 
                step="0.01"
                (blur)="togglePriceEdit()"
                (keyup.enter)="togglePriceEdit()"
                #priceInput
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Secci√≥n 2: Grilla de Stock -->
      <div class="stock-section">
        <h3>üìä Gesti√≥n de Stock por Variante</h3>
        <div class="variantes-table" *ngIf="variantesStock.length > 0">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Color</th>
                <th>Talle</th>
                <th>SKU</th>
                <th>Stock Actual</th>
                <th>Nuevo Stock</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let variante of variantesStock; let i = index; trackBy: trackByVariante">
                <td>
                  <span class="color-indicator" [style.background-color]="getColorValue(variante.color)"></span>
                  {{ variante.color }}
                </td>
                <td>{{ variante.talle }}</td>
                <td><code>{{ variante.sku }}</code></td>
                <td class="stock-value stock-original">{{ variante.stockOriginal }}</td>
                <td class="stock-value stock-new" [class.stock-increased]="variante.stock > variante.stockOriginal" [class.stock-decreased]="variante.stock < variante.stockOriginal">
                  {{ variante.stock }}
                  <span *ngIf="variante.stock !== variante.stockOriginal" class="stock-difference">
                    ({{ variante.stock > variante.stockOriginal ? '+' : '' }}{{ variante.stock - variante.stockOriginal }})
                  </span>
                </td>
                <td class="stock-actions">
                  <button 
                    type="button"
                    class="btn-stock btn-decrease"
                    (click)="decrementStock(i)"
                    title="Reducir stock"
                  >
                    ‚àí
                  </button>
                  <button 
                    type="button"
                    class="btn-stock btn-increase"
                    (click)="incrementStock(i)"
                    title="Aumentar stock"
                  >
                    +
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="variantesStock.length === 0" class="no-variants">
          <p>No hay variantes disponibles para este producto.</p>
        </div>
      </div>

      <!-- Secci√≥n 3: Bot√≥n Guardar -->
      <div class="save-section">
        <button 
          type="button" 
          class="btn btn-primary btn-save"
          (click)="onSubmit()"
          [disabled]="loading"
        >
          <span *ngIf="loading">‚è≥</span>
          <span *ngIf="!loading">‚úÖ</span>
          {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
        <button 
          type="button" 
          class="btn btn-secondary btn-cancel"
          (click)="goToCatalog()"
          [disabled]="loading"
        >
          Cancelar
        </button>
      </div>

      <!-- Secci√≥n 3.5: Ocultar producto -->
      <div class="ocultar-producto-section">
        <div class="form-check">
          <input 
            type="checkbox" 
            id="oculto" 
            name="oculto" 
            [(ngModel)]="productData.oculto"
            class="form-check-input"
          >
          <label for="oculto" class="form-check-label">
            Ocultar producto en el cat√°logo
          </label>
        </div>
        <small class="form-text text-muted">
          Si est√° marcado, el producto no se mostrar√° en el cat√°logo para los clientes
        </small>
      </div>

      <!-- Secci√≥n 4: Opciones Avanzadas (Colapsable) -->
      <div class="advanced-section">
        <button 
          type="button"
          class="btn-advanced-toggle"
          (click)="toggleAdvancedOptions()"
        >
          <span class="warning-icon">‚ö†Ô∏è</span>
          Modificar datos espec√≠ficos de la variante
          <span class="toggle-icon">{{ showAdvancedOptions ? '‚ñº' : '‚ñ∂' }}</span>
        </button>

        <div *ngIf="showAdvancedOptions" class="advanced-options">
          <form (ngSubmit)="onSubmit()" #advancedForm="ngForm">
            <!-- Campos avanzados -->
            <div class="form-row">
              <div class="form-group">
                <label for="tipo">Tipo de Producto *</label>
                <select 
                  id="tipo" 
                  name="tipo" 
                  [(ngModel)]="productData.tipo" 
                  required 
                  class="form-control"
                >
                  <option value="">Seleccionar tipo...</option>
                  <option *ngFor="let tipo of tipoProductos" [value]="tipo">
                    {{ tipo }}
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label for="categoria">Categor√≠a *</label>
                <select 
                  id="categoria" 
                  name="categoria" 
                  [(ngModel)]="productData.categoria" 
                  required 
                  class="form-control"
                >
                  <option [ngValue]="null">Seleccionar categor√≠a...</option>
                  <option value="PLANO">Plano (se compra en rollo)</option>
                  <option value="TEJIDO">Tejido (se hace en rectil√≠nea)</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="sku">SKU *</label>
              <input
                type="text"
                id="sku"
                name="sku"
                [(ngModel)]="productData.sku"
                (input)="onSkuChange($event)"
                required
                class="form-control"
                placeholder="Ej: REM-001-TJ"
              >
            </div>

            <!-- Selecci√≥n de Colores -->
            <div class="form-group" [class.error]="formSubmitted && productData.colores.length === 0">
              <label>Colores Disponibles *</label>
              <div class="color-options">
                <div 
                  *ngFor="let color of opcionesColores" 
                  class="color-option"
                  [class.selected]="isColorSelected(color)"
                  (click)="toggleColor(color)"
                >
                  <span class="color-dot" [style.background-color]="getColorValue(color)"></span>
                  {{ color }}
                </div>
              </div>
              <div class="selected-items" *ngIf="productData.colores.length > 0">
                <strong>Seleccionados:</strong> {{ productData.colores.join(', ') }}
              </div>
            </div>

            <!-- Selecci√≥n de Categor√≠a de Talles -->
            <div class="form-group" [class.error]="formSubmitted && !categoriaTalleSeleccionada">
              <label>Categor√≠a de Talles *</label>
              <div class="category-options">
                <div 
                  *ngFor="let categoria of categoriasTalles" 
                  class="category-option"
                  [class.selected]="categoriaTalleSeleccionada === categoria.id"
                  (click)="selectTalleCategory(categoria.id)"
                >
                  <div class="category-name">{{ categoria.nombre }}</div>
                  <div class="category-examples">{{ categoria.opciones.join(', ') }}</div>
                </div>
              </div>
            </div>

            <!-- Selecci√≥n de Talles Espec√≠ficos -->
            <div class="form-group" [class.error]="formSubmitted && productData.talles.length === 0" *ngIf="categoriaTalleSeleccionada">
              <label>Talles Espec√≠ficos *</label>
              <div class="size-options">
                <div 
                  *ngFor="let talle of getTallesDisponibles()" 
                  class="size-option"
                  [class.selected]="isTalleSelected(talle)"
                  (click)="toggleTalle(talle)"
                >
                  {{ talle }}
                </div>
              </div>
              <div class="selected-items" *ngIf="productData.talles.length > 0">
                <strong>Seleccionado:</strong> {{ productData.talles[0] }}
              </div>
            </div>
          </form>
          
          <!-- Bot√≥n eliminar art√≠culo -->
          <div class="delete-product-section">
            <button 
              type="button" 
              class="btn btn-delete"
              (click)="intentarEliminarProducto()"
            >
              Eliminar Art√≠culo
            </button>
          </div>
        </div>
      </div>

      <!-- Mensajes de error/success -->
      <div *ngIf="error" class="error-message">
        ‚ùå {{ error }}
      </div>

      <div *ngIf="success" class="success-message">
        ‚úÖ {{ success }}
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n para variantes con pedidos -->
  <div *ngIf="showConfirmDialog" class="confirm-dialog-overlay" (click)="cancelarActualizacionConVariantes()">
    <div class="confirm-dialog" (click)="$event.stopPropagation()">
      <div class="confirm-header">
        <h3>‚ö†Ô∏è Variantes con Pedidos Asociados</h3>
        <button class="close-btn" (click)="cancelarActualizacionConVariantes()">√ó</button>
      </div>
      <div class="confirm-content">
        <p class="warning-message">
          Este producto tiene <strong>{{ variantesConPedidos.length }}</strong> variante(s) con pedidos asociados.
        </p>
        <p>
          Si contin√∫as, estas variantes <strong>NO ser√°n eliminadas</strong>, pero su stock ser√° puesto en <strong>0</strong> para evitar futuros pedidos inconsistentes.
        </p>
        
        <div class="variantes-list" *ngIf="variantesConPedidos.length > 0">
          <h4>Variantes afectadas:</h4>
          <ul>
            <li *ngFor="let variante of variantesConPedidos">
              <strong>{{ variante.sku }}</strong> - {{ variante.color }} / {{ variante.talle }}
              <span class="info-badge">
                Stock actual: {{ variante.stockActual }} | Pedidos: {{ variante.cantidadPedidos }}
              </span>
            </li>
          </ul>
        </div>
        
        <p class="action-info">
          ¬øDeseas continuar con la actualizaci√≥n?
        </p>
      </div>
      <div class="confirm-actions">
        <button class="btn btn-secondary" (click)="cancelarActualizacionConVariantes()">
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="confirmarActualizacionConVariantes()">
          Continuar (Poner stock en 0)
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de eliminaci√≥n -->
  <div *ngIf="showDeleteModal" class="confirm-dialog-overlay" (click)="cerrarModalEliminar()">
    <div class="confirm-dialog" (click)="$event.stopPropagation()">
      <div class="confirm-header">
        <h3>‚ö†Ô∏è No se puede eliminar</h3>
        <button class="close-btn" (click)="cerrarModalEliminar()">√ó</button>
      </div>
      <div class="confirm-content">
        <p class="warning-message">
          No se puede eliminar un articulo con pedidos
        </p>
      </div>
      <div class="confirm-actions">
        <button class="btn btn-primary" (click)="cerrarModalEliminar()">
          Aceptar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de b√∫squeda -->
  <div *ngIf="showSearchModal" class="search-modal-overlay" (click)="closeSearchModal()">
    <div class="search-modal" (click)="$event.stopPropagation()">
      <div class="search-header">
        <h3>Buscar en la p√°gina</h3>
        <button class="close-btn" (click)="closeSearchModal()">√ó</button>
      </div>
      <div class="search-input-container">
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="performSearch()"
          placeholder="Escribe lo que quieres buscar..."
          class="search-input"
          autofocus
        >
      </div>
      <div class="search-results" *ngIf="searchResults.length > 0">
        <div class="search-result-item" 
             *ngFor="let result of searchResults" 
             (click)="scrollToResult(result)">
          <div class="result-type">{{ result.type === 'campo' ? 'üìù' : 'üìÑ' }}</div>
          <div class="result-content">
            <div class="result-title">{{ result.title }}</div>
            <div class="result-description">{{ result.description }}</div>
          </div>
        </div>
      </div>
      <div class="no-results" *ngIf="searchTerm && searchResults.length === 0">
        <p>No se encontraron resultados para "{{ searchTerm }}"</p>
      </div>
    </div>
  </div>

  <!-- Modal de mensajes -->
  <div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
    <div class="modal-dialog" [class.success]="modalEsExito" (click)="$event.stopPropagation()">
      <h3>{{ modalEsExito ? 'Operaci√≥n exitosa' : 'Aviso' }}</h3>
      <pre class="modal-message">{{ modalMensaje }}</pre>
      <button type="button" class="btn-secondary" (click)="cerrarModal()">Aceptar</button>
    </div>
  </div>
</div>
