<div class="devolucion-page">
  <!-- Header estilo catÃ¡logo -->
  <div class="catalog-header">
    <div class="header-left">
      <div class="logo" (click)="goToCatalog()">
        <div class="logo-symbol">
          <img src="/HIRKUM-MONOGRAMA-B.jpg" alt="HIRKUM Logo" class="logo-image">
        </div>
        <span>HRK</span>
      </div>
      <nav class="main-nav">
        <a (click)="goToCatalog()" class="nav-item">SHOP</a>
        <a (click)="goToCatalog()" class="nav-item sale">SALE</a>
        <a (click)="goToInfo()" class="nav-item info">info</a>
      </nav>
    </div>
    <div class="header-right">
      <button class="icon-btn cart-icon" title="Volver al carrito" (click)="goToCart()">
        ðŸ›’
        <span *ngIf="cartItemCount > 0" class="cart-badge">{{ cartItemCount }}</span>
      </button>
      <button class="icon-btn history-btn" title="Historial" (click)="volverAlHistorial()">ðŸ“‹</button>
      <button class="icon-btn user-icon" title="Perfil" (click)="goToProfile()">
        <img src="/images/user-icon.png" alt="Usuario" class="user-icon-img"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
        <span class="user-icon-fallback" style="display:none;">ðŸ‘¤</span>
      </button>
      <button class="logout-btn" (click)="logout()" title="Cerrar SesiÃ³n">
        Cerrar SesiÃ³n
      </button>
    </div>
  </div>

  <div class="client-banner" *ngIf="cliente">
    <span class="client-label">Cliente seleccionado:</span>
    <span class="client-name">{{ cliente.nombreRazonSocial }}</span>
    <span class="client-email">{{ cliente.email }}</span>
  </div>

<!-- Contenido principal -->
  <div class="devolucion-container">
  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-state">
    <p>Cargando pedidos entregados...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-state">
    <p>{{ error }}</p>
    <button (click)="volverAlHistorial()" class="btn-secondary">
      Volver al Historial
    </button>
  </div>

  <!-- Sin pedidos entregados -->
  <div *ngIf="!loading && !error && pedidosEntregados.length === 0" class="empty-state">
    <h3>No hay pedidos entregados</h3>
    <p>Este cliente no tiene pedidos entregados para generar una devoluciÃ³n.</p>
    <button (click)="volverAlHistorial()" class="btn-primary">
      Volver al Historial
    </button>
  </div>

  <!-- Lista de pedidos entregados -->
  <div *ngIf="!loading && !error && pedidosEntregados.length > 0" class="pedidos-section">
    <div class="section-header">
      <h2>Pedidos Entregados</h2>
      <p>Selecciona los items que deseas incluir en la nota de devoluciÃ³n</p>
    </div>

    <div class="pedidos-list">
      <div *ngFor="let pedido of pedidosEntregados" class="pedido-card">
        <button type="button" class="pedido-header" (click)="togglePedidoExpandido(pedido.id)">
          <div class="pedido-title">
            <h3>Pedido #{{ pedido.id }}</h3>
            <span class="badge">{{ formatearFecha(pedido.fecha.toString()) }}</span>
            <span class="badge monto">{{ formatearMonto(pedido.montoTotal) }}</span>
          </div>
          <div class="toggle-icon">
            {{ pedidosExpandido[pedido.id] ? 'â–²' : 'â–¼' }}
          </div>
        </button>

        <div class="items-section" *ngIf="pedidosExpandido[pedido.id]">
          <h4>Items del Pedido</h4>
          <div *ngIf="pedido.items && pedido.items.length > 0; else noItems" class="items-list">
            <div *ngFor="let item of pedido.items" class="item-row">
              <div class="item-checkbox">
                <input 
                  type="checkbox" 
                  [id]="'item-' + pedido.id + '-' + item.id"
                  [checked]="isItemSeleccionado(pedido.id, item.id)"
                  (change)="toggleItemSeleccion(pedido.id, item.id, $event)"
                  class="checkbox-input">
                <label [for]="'item-' + pedido.id + '-' + item.id" class="checkbox-label">
                  Seleccionar
                </label>
              </div>
              
              <div class="item-info">
                <div class="item-producto">
                  <strong>{{ item.productoNombre || ('Producto #' + item.productoId) }} - ID {{ item.productoId }}</strong>
                  <span class="item-variante">{{ item.variante?.color }} - {{ item.variante?.talle }}</span>
                </div>
                <div class="item-details">
                  <div class="cantidad-section">
                    <span class="cantidad-label">Cantidad original: {{ item.cantidad }}</span>
                    <div *ngIf="getDisponibilidadVariante(item.variante?.id)" class="disponibilidad-info">
                      <span class="disponibilidad-text">
                        Disponible para devolver: 
                        <strong>{{ getDisponibilidadVariante(item.variante?.id)?.disponibleParaDevolver }}</strong>
                        (Entregados: {{ getDisponibilidadVariante(item.variante?.id)?.totalEntregado }}, 
                        Ya devueltos: {{ getDisponibilidadVariante(item.variante?.id)?.totalDevuelto }})
                      </span>
                    </div>
                    <div *ngIf="isItemSeleccionado(pedido.id, item.id)" class="cantidad-devolucion">
                      <label>Cantidad a devolver:</label>
                      <input 
                        type="number" 
                        [value]="getCantidadDevolucion(pedido.id, item.id)"
                        (input)="onCantidadInput($event, pedido.id, item.id)"
                        [max]="getCantidadMaxima(pedido.id, item.id)"
                        [min]="getCantidadMaxima(pedido.id, item.id) > 0 ? 1 : 0"
                        [disabled]="getCantidadMaxima(pedido.id, item.id) <= 0"
                        class="cantidad-input"
                        [class.disabled]="getCantidadMaxima(pedido.id, item.id) <= 0"
                      >
                      <span class="cantidad-max">(mÃ¡x: {{ getCantidadMaxima(pedido.id, item.id) }})</span>
                      <span *ngIf="getCantidadMaxima(pedido.id, item.id) <= 0" class="no-disponible-msg">
                        No hay unidades disponibles para devolver
                      </span>
                    </div>
                  </div>
                  <span class="precio">Precio: {{ formatearMonto(item.precioUnitario) }}</span>
                  <span class="subtotal">Subtotal: {{ formatearMonto(item.subtotal) }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #noItems>
            <p class="no-items">No hay items en este pedido</p>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Resumen y acciones -->
    <div class="resumen-section">
      <div class="resumen-info">
        <h3>Resumen de SelecciÃ³n</h3>
        <p>Items seleccionados: <strong>{{ getItemsSeleccionados().length }}</strong></p>
      </div>
      
      <div class="actions">
        <button (click)="volverAlHistorial()" class="btn-secondary">
          Cancelar
        </button>
        <button 
          (click)="generarNotaDevolucion()" 
          class="btn-primary"
          [disabled]="getItemsSeleccionados().length === 0">
          Generar Nota de DevoluciÃ³n
        </button>
      </div>
    </div>
  </div>
</div>