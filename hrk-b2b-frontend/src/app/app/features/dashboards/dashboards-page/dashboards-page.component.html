<div class="dashboards-container">
  <!-- Header negro con logo y navegaci√≥n -->
  <div class="catalog-header">
    <div class="header-left">
      <div class="logo" (click)="goToCatalog()">
        <div class="logo-symbol">
          <img src="/HIRKUM-MONOGRAMA-B.jpg" alt="HIRKUM Logo" class="logo-image">
        </div>
        <span>HRK</span>
      </div>
      <nav class="main-nav">
        <a (click)="goToCatalog()" class="nav-item">SHOP</a>
        <a (click)="goToCatalog()" class="nav-item sale">SALE</a>
        <a (click)="goToInfo()" class="nav-item info">info</a>
      </nav>
    </div>
    
    <div class="header-right">
      <button class="icon-btn cart-icon" title="Carrito" (click)="goToCart()">
        üõí
        <span *ngIf="cartItemCount > 0" class="cart-badge">{{ cartItemCount }}</span>
      </button>
      <button class="icon-btn search-icon" title="Buscar" style="display: none;">
        üîç
      </button>
      <button class="icon-btn history-btn" title="Historial de Pedidos" (click)="goToHistory()">
        üìã
      </button>
      <button class="icon-btn user-icon" title="Perfil de Usuario" (click)="goToProfile()">
        <img src="/images/user-icon.png" alt="Usuario" class="user-icon-img"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
        <span class="user-icon-fallback" style="display:none;">üë§</span>
      </button>
      <button class="logout-btn" (click)="logout()" title="Cerrar Sesi√≥n">
        Cerrar Sesi√≥n
      </button>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="dashboards-content">
    <h1 class="page-title">üìä M√©tricas del Negocio</h1>
    
    <!-- Fila de gr√°ficos: % Vendido y Total Facturado -->
    <div class="charts-row">
      <!-- Gr√°fico de torta: % Vendido sobre Stock Hist√≥rico -->
      <div class="chart-section half-width">
        <div class="chart-card">
        <div class="chart-header">
          <h3>% Vendido sobre Stock Hist√≥rico</h3>
          <div class="period-selector">
            <label for="periodSelect">Per√≠odo:</label>
            <select id="periodSelect" [(ngModel)]="selectedPeriod" (change)="onPeriodChange()" class="period-dropdown">
              <option [value]="0.033">1 d√≠a</option>
              <option [value]="1">1 mes</option>
              <option [value]="3">3 meses</option>
              <option [value]="6">6 meses</option>
              <option [value]="12">12 meses</option>
            </select>
          </div>
        </div>
        <div *ngIf="loadingChart" class="loading-metric">
          Cargando...
        </div>
        <div *ngIf="!loadingChart && chartData" class="chart-container">
          <div class="pie-chart">
            <svg width="200" height="200" viewBox="0 0 200 200">
              <circle
                cx="100"
                cy="100"
                r="80"
                fill="none"
                stroke="#e0e0e0"
                stroke-width="40"
              />
              <circle
                cx="100"
                cy="100"
                r="80"
                fill="none"
                stroke="#8b5cf6"
                stroke-width="40"
                [attr.stroke-dasharray]="circumference"
                [attr.stroke-dashoffset]="dashOffset"
                transform="rotate(-90 100 100)"
                class="progress-circle"
              />
            </svg>
            <div class="chart-center">
              <span class="chart-percentage">{{ chartData.porcentajeVendido }}%</span>
            </div>
          </div>
          <div class="chart-info">
            <p><strong>Total Vendido:</strong> {{ chartData.totalVendido }} unidades</p>
            <p><strong>Stock Hist√≥rico:</strong> {{ chartData.totalStockHistorico }} unidades</p>
          </div>
        </div>
        <div *ngIf="!loadingChart && !chartData" class="error-metric">
          Error al cargar el gr√°fico
        </div>
        </div>
      </div>

      <!-- Gr√°fico de Total Facturado -->
      <div class="chart-section half-width">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Total Facturado</h3>
            <div class="period-selector">
              <label for="periodSelectFacturacion">Per√≠odo:</label>
              <select id="periodSelectFacturacion" [(ngModel)]="selectedPeriodFacturacion" (change)="onPeriodFacturacionChange()" class="period-dropdown">
                <option [value]="1">1 mes</option>
                <option [value]="3">3 meses</option>
                <option [value]="6">6 meses</option>
                <option [value]="9">9 meses</option>
                <option [value]="12">12 meses</option>
              </select>
            </div>
          </div>
          <div *ngIf="loadingTotalFacturado" class="loading-metric">
            Cargando...
          </div>
          <div *ngIf="!loadingTotalFacturado && totalFacturadoData" class="total-facturado-container">
            <div class="total-facturado-value">
              <span class="currency-symbol">$</span>
              <span class="amount">{{ totalFacturadoData.totalFacturado | number:'1.2-2' }}</span>
            </div>
            <div class="total-facturado-info">
              <span class="info-text">{{ totalFacturadoData.cantidadPedidos }} pedidos</span>
            </div>
            
            <!-- Gr√°fico de barras horizontal: Top 3 clientes -->
            <div *ngIf="topClientesData && topClientesData.length > 0" class="top-clientes-chart">
              <div class="horizontal-bars">
                <div *ngFor="let cliente of topClientesData; let i = index" class="horizontal-bar-item">
                  <div class="bar-label-horizontal">
                    <span class="cliente-rank">{{ i + 1 }}.</span>
                    <span class="cliente-name">{{ cliente.nombreCliente }}</span>
                  </div>
                  <div class="bar-container-horizontal">
                    <div 
                      class="bar-fill-horizontal" 
                      [style.width.%]="getClienteBarWidth(cliente.montoTotal)"
                      [class.bar-client1]="i === 0"
                      [class.bar-client2]="i === 1"
                      [class.bar-client3]="i === 2">
                      <span class="bar-value-horizontal">${{ cliente.montoTotal | number:'1.2-2' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="!loadingTotalFacturado && (!topClientesData || topClientesData.length === 0)" class="no-clientes-data">
              No hay datos de clientes en este per√≠odo
            </div>
          </div>
          <div *ngIf="!loadingTotalFacturado && !totalFacturadoData" class="no-data">
            No hay datos de facturaci√≥n en este per√≠odo
          </div>
        </div>
      </div>
    </div>

    <!-- M√©tricas expandibles -->
    <div class="metrics-actions">
      <!-- Top Art√≠culos M√°s Vendidos - Gr√°fico de Barras (Expandible) -->
      <button 
        class="metric-action-btn" 
        (click)="toggleTopArticulos()"
        [class.expanded]="topArticulosExpandido">
        <span>Top Art√≠culos M√°s Vendidos</span>
        <span class="icon">{{ topArticulosExpandido ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="topArticulosExpandido" class="metric-content">
        <div class="chart-section">
          <div class="chart-card">
            <div class="chart-header">
              <h3>Top Art√≠culos M√°s Vendidos</h3>
              <div class="period-selector">
                <label for="periodSelectTopArticulos">Per√≠odo:</label>
                <select id="periodSelectTopArticulos" [(ngModel)]="selectedPeriodTopArticulos" (change)="onPeriodTopArticulosChange()" class="period-dropdown">
                  <option [value]="0.033">1 d√≠a</option>
                  <option [value]="1">1 mes</option>
                  <option [value]="3">3 meses</option>
                  <option [value]="6">6 meses</option>
                  <option [value]="9">9 meses</option>
                  <option [value]="12">12 meses</option>
                </select>
              </div>
            </div>
            <div *ngIf="loadingTopArticulos" class="loading-metric">
              Cargando...
            </div>
            <div *ngIf="!loadingTopArticulos && topArticulosData && topArticulosData.length > 0" class="bar-chart-container">
              <div class="vertical-bar-chart">
                <div class="y-axis">
                  <div *ngFor="let tick of yAxisTicks" class="y-tick">
                    <span class="tick-value">{{ tick }}</span>
                    <span class="tick-line"></span>
                  </div>
                </div>
                <div class="bars-container">
                  <div *ngFor="let item of topArticulosData; let i = index" class="bar-item-vertical">
                    <div class="bar-wrapper-vertical">
                      <div 
                        class="bar-fill-vertical clickable-bar" 
                        [style.height.%]="getBarHeight(item.cantidadVendida)"
                        [class.bar-top1]="i === 0"
                        [class.bar-top2]="i === 1"
                        [class.bar-top3]="i === 2"
                        [class.bar-other]="i > 2"
                        [class.bar-selected]="productoSeleccionado === item.productoId"
                        (click)="seleccionarProducto(item.productoId)">
                        <span class="bar-value-vertical">{{ item.cantidadVendida }}</span>
                      </div>
                    </div>
                    <div class="bar-label-vertical">
                      <span class="bar-rank-vertical">{{ i + 1 }}.</span>
                      <span class="bar-name-vertical clickable-name" (click)="seleccionarProducto(item.productoId)">{{ item.nombre }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="!loadingTopArticulos && (!topArticulosData || topArticulosData.length === 0)" class="no-data">
              No hay datos de art√≠culos vendidos en este per√≠odo
            </div>
            
            <!-- Bot√≥n para ver todos los art√≠culos -->
            <div class="ver-todos-articulos-section">
              <button 
                class="btn-ver-todos" 
                (click)="toggleTodosArticulos()"
                [class.expanded]="mostrarTodosArticulos">
                <span>{{ mostrarTodosArticulos ? 'Ocultar todos los art√≠culos' : 'Ver todos los art√≠culos' }}</span>
                <span class="icon">{{ mostrarTodosArticulos ? '‚àí' : '+' }}</span>
              </button>
              
              <div *ngIf="mostrarTodosArticulos" class="todos-articulos-dropdown">
                <div *ngIf="loadingTodosArticulos" class="loading-metric">
                  Cargando todos los art√≠culos...
                </div>
                <div *ngIf="!loadingTodosArticulos && todosArticulosData && todosArticulosData.length > 0" class="articulos-select-container">
                  <label for="articuloSelect">Seleccionar art√≠culo:</label>
                  <select 
                    id="articuloSelect" 
                    class="articulo-select"
                    size="8"
                    (change)="onArticuloSeleccionado($event)">
                    <option *ngFor="let articulo of todosArticulosData" [value]="articulo.productoId">
                      {{ articulo.nombre }} ({{ articulo.cantidadVendida }} vendidas)
                    </option>
                  </select>
                </div>
                <div *ngIf="!loadingTodosArticulos && (!todosArticulosData || todosArticulosData.length === 0)" class="no-data">
                  No hay art√≠culos en este per√≠odo
                </div>
              </div>
            </div>
            
            <!-- Detalles del producto seleccionado -->
            <div *ngIf="productoSeleccionado && detallesProducto" class="producto-detalles">
              <div class="detalles-header">
                <h4>{{ detallesProducto.nombreProducto }}</h4>
                <button class="close-details" (click)="cerrarDetallesProducto()">‚úï</button>
              </div>
              
              <div class="detalles-stats">
                <div class="stat-item">
                  <span class="stat-label">% Vendido sobre Stock Hist√≥rico:</span>
                  <span class="stat-value highlight">{{ detallesProducto.porcentajeVendido }}%</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Stock Hist√≥rico Total:</span>
                  <span class="stat-value">{{ detallesProducto.stockHistoricoTotal }} unidades</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Ventas Totales:</span>
                  <span class="stat-value">{{ detallesProducto.ventasTotales }} unidades</span>
                </div>
              </div>
              
              <div class="variantes-detalle">
                <h5>Ventas por Variante:</h5>
                <div class="variantes-list">
                  <div *ngFor="let variante of detallesProducto.variantes" class="variante-item">
                    <div class="variante-info">
                      <span class="variante-sku">{{ variante.sku }}</span>
                      <span class="variante-attr">{{ variante.color }} - Talle {{ variante.talle }}</span>
                    </div>
                    <div class="variante-stats">
                      <span class="variante-venta">{{ variante.cantidadVendida }} vendidas</span>
                      <span class="variante-stock">Stock hist√≥rico: {{ variante.stockHistorico }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('ordenesCanceladas')"
        [class.expanded]="metricasExpandidas.ordenesCanceladas">
        <span>√ìrdenes Canceladas</span>
        <span class="icon">{{ metricasExpandidas.ordenesCanceladas ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.ordenesCanceladas" class="metric-content">
        <div class="chart-header">
          <h3>√ìrdenes Canceladas</h3>
          <div class="period-selector">
            <label for="periodSelectOrdenesCanceladas">Per√≠odo:</label>
            <select id="periodSelectOrdenesCanceladas" [(ngModel)]="selectedPeriodOrdenesCanceladas" (change)="onPeriodOrdenesCanceladasChange()" class="period-dropdown">
              <option [value]="0.033">1 d√≠a</option>
              <option [value]="1">1 mes</option>
              <option [value]="3">3 meses</option>
              <option [value]="6">6 meses</option>
              <option [value]="9">9 meses</option>
              <option [value]="12">12 meses</option>
            </select>
          </div>
        </div>
        <div *ngIf="loadingMetricas.ordenesCanceladas" class="loading-metric">Cargando...</div>
        <div *ngIf="!loadingMetricas.ordenesCanceladas && metricasData.ordenesCanceladas !== null" class="metric-value-large">
          {{ metricasData.ordenesCanceladas }}
        </div>
      </div>

      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('medioPago')"
        [class.expanded]="metricasExpandidas.medioPago">
        <span>Medio de Pago M√°s Usado</span>
        <span class="icon">{{ metricasExpandidas.medioPago ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.medioPago" class="metric-content">
        <div class="chart-header">
          <h3>Medio de Pago M√°s Usado</h3>
          <div class="period-selector">
            <label for="periodSelectMedioPago">Per√≠odo:</label>
            <select id="periodSelectMedioPago" [(ngModel)]="selectedPeriodMedioPago" (change)="onPeriodMedioPagoChange()" class="period-dropdown">
              <option [value]="0.033">1 d√≠a</option>
              <option [value]="1">1 mes</option>
              <option [value]="3">3 meses</option>
              <option [value]="6">6 meses</option>
              <option [value]="9">9 meses</option>
              <option [value]="12">12 meses</option>
            </select>
          </div>
        </div>
        <div *ngIf="loadingMetricas.medioPago" class="loading-metric">Cargando...</div>
        <div *ngIf="!loadingMetricas.medioPago && metricasData.medioPago" class="metric-info">
          <p class="metric-value-large">{{ metricasData.medioPago.metodo }}</p>
          <p class="metric-subtitle">Usado {{ metricasData.medioPago.cantidad }} veces</p>
        </div>
      </div>

      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('devoluciones')"
        [class.expanded]="metricasExpandidas.devoluciones">
        <span>Devoluciones</span>
        <span class="icon">{{ metricasExpandidas.devoluciones ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.devoluciones" class="metric-content">
        <div class="chart-header">
          <h3>Devoluciones</h3>
          <div class="period-selector">
            <label for="periodSelectDevoluciones">Per√≠odo:</label>
            <select id="periodSelectDevoluciones" [(ngModel)]="selectedPeriodDevoluciones" (change)="onPeriodDevolucionesChange()" class="period-dropdown">
              <option [value]="0.033">1 d√≠a</option>
              <option [value]="1">1 mes</option>
              <option [value]="3">3 meses</option>
              <option [value]="6">6 meses</option>
              <option [value]="9">9 meses</option>
              <option [value]="12">12 meses</option>
            </select>
          </div>
        </div>
        <div *ngIf="loadingMetricas.devoluciones" class="loading-metric">Cargando...</div>
        <div *ngIf="!loadingMetricas.devoluciones && metricasData.devoluciones" class="metric-info">
          <p><strong>Aptas:</strong> {{ metricasData.devoluciones.aptas }}</p>
          <p><strong>Scrap:</strong> {{ metricasData.devoluciones.scrap }}</p>
          <p><strong>Pendientes:</strong> {{ metricasData.devoluciones.pendientes }}</p>
          <p><strong>Total:</strong> {{ metricasData.devoluciones.total }}</p>
        </div>
      </div>

      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('clientesSinCompras')"
        [class.expanded]="metricasExpandidas.clientesSinCompras">
        <span>Clientes que no compraron</span>
        <span class="icon">{{ metricasExpandidas.clientesSinCompras ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.clientesSinCompras" class="metric-content">
        <div class="chart-header">
          <h3>Clientes que no compraron</h3>
          <div class="period-selector">
            <label for="periodSelectClientesSinCompras">Per√≠odo:</label>
            <select id="periodSelectClientesSinCompras" [(ngModel)]="selectedPeriodClientesSinCompras" (change)="onPeriodClientesSinComprasChange()" class="period-dropdown">
              <option [value]="0.033">1 d√≠a</option>
              <option [value]="1">1 mes</option>
              <option [value]="3">3 meses</option>
              <option [value]="6">6 meses</option>
              <option [value]="9">9 meses</option>
              <option [value]="12">12 meses</option>
            </select>
          </div>
        </div>
        
        <div *ngIf="loadingMetricas.clientesSinCompras" class="loading-metric">
          Cargando...
        </div>
        
        <div *ngIf="!loadingMetricas.clientesSinCompras && metricasData.clientesSinCompras">
          <div *ngIf="metricasData.clientesSinCompras.totalSinCompras === 0" class="no-data-message">
            <p>‚úÖ Todos los clientes han realizado compras en este per√≠odo</p>
            <p class="metric-subtitle">Total de clientes: {{ metricasData.clientesSinCompras.totalClientes }}</p>
          </div>
          
          <div *ngIf="metricasData.clientesSinCompras.totalSinCompras > 0" class="clientes-sin-compras-container">
            <div class="metric-info">
              <p><strong>Clientes sin compras:</strong> {{ metricasData.clientesSinCompras.totalSinCompras }}</p>
              <p class="metric-subtitle">Total de clientes: {{ metricasData.clientesSinCompras.totalClientes }}</p>
            </div>
            
            <div class="clientes-select-container">
              <label for="clienteSelect">Seleccionar cliente:</label>
              <select 
                id="clienteSelect" 
                class="cliente-select"
                [attr.size]="clientesSelectSize"
                (change)="onClienteSeleccionado($event)">
                <option *ngFor="let cliente of metricasData.clientesSinCompras.clientesSinCompras" [value]="cliente.clienteId">
                  {{ cliente.nombreCliente }} ({{ cliente.email }})
                </option>
              </select>
            </div>
            
            <!-- Detalles del cliente seleccionado -->
            <div *ngIf="clienteSeleccionado && ultimaCompraData" class="cliente-detalles">
              <div class="detalles-header">
                <h4>{{ clienteSeleccionado.nombreCliente }}</h4>
                <button class="close-details" (click)="cerrarDetallesCliente()">‚úï</button>
              </div>
              
              <div class="detalles-stats">
                <div class="stat-item">
                  <span class="stat-label">Email:</span>
                  <span class="stat-value">{{ clienteSeleccionado.email }}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">CUIT:</span>
                  <span class="stat-value">{{ clienteSeleccionado.cuit }}</span>
                </div>
                
                <div *ngIf="loadingUltimaCompra" class="loading-metric">
                  Cargando √∫ltima compra...
                </div>
                
                <div *ngIf="!loadingUltimaCompra && ultimaCompraData.tieneCompras" class="ultima-compra-info">
                  <div class="stat-item">
                    <span class="stat-label">√öltima compra:</span>
                    <span class="stat-value highlight">{{ ultimaCompraData.ultimaCompraFecha | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Monto:</span>
                    <span class="stat-value">${{ ultimaCompraData.ultimaCompraTotal | number:'1.2-2' }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Estado:</span>
                    <span class="stat-value">{{ ultimaCompraData.ultimaCompraEstado }}</span>
                  </div>
                </div>
                
                <div *ngIf="!loadingUltimaCompra && !ultimaCompraData.tieneCompras" class="no-compra-message">
                  <p>{{ ultimaCompraData.mensaje }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

