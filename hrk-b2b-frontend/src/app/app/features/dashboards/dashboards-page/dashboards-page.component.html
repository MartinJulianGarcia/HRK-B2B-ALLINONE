<div class="dashboards-container">
  <!-- Header negro con logo y navegaci√≥n -->
  <div class="dashboards-header">
    <div class="header-left">
      <div class="logo" (click)="goToCatalog()">
        <div class="logo-symbol">
          <img src="/HIRKUM-MONOGRAMA-B.jpg" alt="HIRKUM Logo" class="logo-image">
        </div>
        <span>HRK</span>
      </div>
      <nav class="main-nav">
        <a (click)="goToCatalog()" class="nav-item">SHOP</a>
        <a (click)="goToCatalog()" class="nav-item sale">SALE</a>
        <a (click)="goToInfo()" class="nav-item info">info</a>
      </nav>
    </div>
    
    <div class="header-right">
      <button class="icon-btn cart-icon" title="Carrito" (click)="goToCart()">
        üõí
        <span *ngIf="cartItemCount > 0" class="cart-badge">{{ cartItemCount }}</span>
      </button>
      <button class="icon-btn search-icon" title="Buscar" style="display: none;">
        üîç
      </button>
      <button class="icon-btn history-btn" title="Historial de Pedidos" (click)="goToHistory()">
        üìã
      </button>
      <button class="icon-btn user-icon" title="Perfil de Usuario" (click)="goToProfile()">
        <img src="/images/user-icon.png" alt="Usuario" class="user-icon-img"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
        <span class="user-icon-fallback" style="display:none;">üë§</span>
      </button>
      <button class="logout-btn" (click)="logout()" title="Cerrar Sesi√≥n">
        Cerrar Sesi√≥n
      </button>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="dashboards-content">
    <h1 class="page-title">üìä M√©tricas del Negocio</h1>
    
    <!-- Gr√°fico de torta: % Vendido sobre Stock Hist√≥rico (√∫ltimos 3 meses) -->
    <div class="chart-section">
      <div class="chart-card">
        <div class="chart-header">
          <h3>% Vendido sobre Stock Hist√≥rico</h3>
          <div class="period-selector">
            <label for="periodSelect">Per√≠odo:</label>
            <select id="periodSelect" [(ngModel)]="selectedPeriod" (change)="onPeriodChange()" class="period-dropdown">
              <option [value]="0.033">1 d√≠a</option>
              <option [value]="1">1 mes</option>
              <option [value]="3">3 meses</option>
              <option [value]="6">6 meses</option>
              <option [value]="12">12 meses</option>
            </select>
          </div>
        </div>
        <div *ngIf="loadingChart" class="loading-metric">
          Cargando...
        </div>
        <div *ngIf="!loadingChart && chartData" class="chart-container">
          <div class="pie-chart">
            <svg width="200" height="200" viewBox="0 0 200 200">
              <circle
                cx="100"
                cy="100"
                r="80"
                fill="none"
                stroke="#e0e0e0"
                stroke-width="40"
              />
              <circle
                cx="100"
                cy="100"
                r="80"
                fill="none"
                stroke="#8b5cf6"
                stroke-width="40"
                [attr.stroke-dasharray]="circumference"
                [attr.stroke-dashoffset]="dashOffset"
                transform="rotate(-90 100 100)"
                class="progress-circle"
              />
            </svg>
            <div class="chart-center">
              <span class="chart-percentage">{{ chartData.porcentajeVendido }}%</span>
            </div>
          </div>
          <div class="chart-info">
            <p><strong>Total Vendido:</strong> {{ chartData.totalVendido }} unidades</p>
            <p><strong>Stock Hist√≥rico:</strong> {{ chartData.totalStockHistorico }} unidades</p>
          </div>
        </div>
        <div *ngIf="!loadingChart && !chartData" class="error-metric">
          Error al cargar el gr√°fico
        </div>
      </div>
    </div>

    <!-- Top Art√≠culos M√°s Vendidos - Gr√°fico de Barras -->
    <div class="chart-section">
      <div class="chart-card">
        <h3>Top Art√≠culos M√°s Vendidos</h3>
        <div *ngIf="loadingTopArticulos" class="loading-metric">
          Cargando...
        </div>
        <div *ngIf="!loadingTopArticulos && topArticulosData && topArticulosData.length > 0" class="bar-chart-container">
          <div class="vertical-bar-chart">
            <div class="y-axis">
              <div *ngFor="let tick of yAxisTicks" class="y-tick">
                <span class="tick-value">{{ tick }}</span>
                <span class="tick-line"></span>
              </div>
            </div>
            <div class="bars-container">
              <div *ngFor="let item of topArticulosData; let i = index" class="bar-item-vertical">
                <div class="bar-wrapper-vertical">
                  <div 
                    class="bar-fill-vertical" 
                    [style.height.%]="getBarHeight(item.cantidadVendida)"
                    [class.bar-top1]="i === 0"
                    [class.bar-top2]="i === 1"
                    [class.bar-top3]="i === 2"
                    [class.bar-other]="i > 2">
                    <span class="bar-value-vertical">{{ item.cantidadVendida }}</span>
                  </div>
                </div>
                <div class="bar-label-vertical">
                  <span class="bar-rank-vertical">{{ i + 1 }}.</span>
                  <span class="bar-name-vertical">{{ item.nombre }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="!loadingTopArticulos && (!topArticulosData || topArticulosData.length === 0)" class="no-data">
          No hay datos de art√≠culos vendidos en este per√≠odo
        </div>
      </div>
    </div>

    <!-- M√©tricas expandibles -->
    <div class="metrics-actions">
      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('ordenesCanceladas')"
        [class.expanded]="metricasExpandidas.ordenesCanceladas">
        <span>√ìrdenes Canceladas</span>
        <span class="icon">{{ metricasExpandidas.ordenesCanceladas ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.ordenesCanceladas" class="metric-content">
        <div *ngIf="loadingMetricas.ordenesCanceladas" class="loading-metric">Cargando...</div>
        <div *ngIf="!loadingMetricas.ordenesCanceladas && metricasData.ordenesCanceladas !== null" class="metric-value-large">
          {{ metricasData.ordenesCanceladas }}
        </div>
      </div>

      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('medioPago')"
        [class.expanded]="metricasExpandidas.medioPago">
        <span>Medio de Pago M√°s Usado</span>
        <span class="icon">{{ metricasExpandidas.medioPago ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.medioPago" class="metric-content">
        <div *ngIf="loadingMetricas.medioPago" class="loading-metric">Cargando...</div>
        <div *ngIf="!loadingMetricas.medioPago && metricasData.medioPago" class="metric-info">
          <p class="metric-value-large">{{ metricasData.medioPago.metodo }}</p>
          <p class="metric-subtitle">Usado {{ metricasData.medioPago.cantidad }} veces</p>
        </div>
      </div>

      <button 
        class="metric-action-btn" 
        (click)="toggleMetric('devoluciones')"
        [class.expanded]="metricasExpandidas.devoluciones">
        <span>Devoluciones</span>
        <span class="icon">{{ metricasExpandidas.devoluciones ? '‚àí' : '+' }}</span>
      </button>
      
      <div *ngIf="metricasExpandidas.devoluciones" class="metric-content">
        <div *ngIf="loadingMetricas.devoluciones" class="loading-metric">Cargando...</div>
        <div *ngIf="!loadingMetricas.devoluciones && metricasData.devoluciones" class="metric-info">
          <p><strong>Aptas:</strong> {{ metricasData.devoluciones.aptas }}</p>
          <p><strong>Scrap:</strong> {{ metricasData.devoluciones.scrap }}</p>
          <p><strong>Pendientes:</strong> {{ metricasData.devoluciones.pendientes }}</p>
          <p><strong>Total:</strong> {{ metricasData.devoluciones.total }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

